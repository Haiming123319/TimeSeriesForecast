# =============================================================================
# ğŸš€ Colabå¿«é€Ÿå¯åŠ¨ - å¤åˆ¶ç²˜è´´è¿è¡Œ (æ–¹æ¡ˆAæœ€ç»ˆç‰ˆ)
# =============================================================================
# 
# ä¼˜åŒ–ç‰ˆAEMOæ—¶åºé¢„æµ‹è®­ç»ƒ
# æ€»æ—¶é—´: çº¦6-8å°æ—¶
# å®éªŒæ•°: 43ä¸ªï¼ˆåŸ120ä¸ªï¼Œå‡å°‘64%ï¼‰
# 
# GPUä¼˜åŒ– (æ–¹æ¡ˆA):
# - TimesNet: å…³é—­AMPï¼Œä½¿ç”¨FP32ï¼ˆé¿å…cuFFTé”™è¯¯ï¼‰
# - å…¶ä»–æ¨¡å‹: å¼€å¯AMPï¼Œä½¿ç”¨FP16åŠ é€Ÿï¼ˆé€Ÿåº¦æå‡30-70%ï¼‰
# 
# =============================================================================


# =============================================================================
# ä»£ç å— 1: ç¯å¢ƒè®¾ç½®ï¼ˆ5åˆ†é’Ÿï¼‰
# =============================================================================
import os

print("ğŸ” æ£€æŸ¥GPU...")
!nvidia-smi

print("\nğŸ“¥ å…‹éš†æœ€æ–°ä»£ç ...")
if os.path.exists('/content/TimeSeriesForecast'):
    !rm -rf /content/TimeSeriesForecast

!git clone https://github.com/yhm-amber/Time-Series-Library.git /content/TimeSeriesForecast

os.chdir('/content/TimeSeriesForecast')

print("\nğŸ“¦ å®‰è£…ä¾èµ–...")
!pip install -q torch numpy pandas scikit-learn matplotlib einops transformers reformer_pytorch statsmodels scipy

# ä¿®å¤ä»£ç 
print("\nğŸ”§ ä¿®å¤å¯¼å…¥é—®é¢˜...")
with open('data_provider/data_loader.py', 'r') as f:
    content = f.read()
if 'from sktime.datasets import load_from_tsfile_to_dataframe' in content and 'try:' not in content:
    content = content.replace(
        'from sktime.datasets import load_from_tsfile_to_dataframe',
        'try:\n    from sktime.datasets import load_from_tsfile_to_dataframe\nexcept:\n    load_from_tsfile_to_dataframe = None'
    )
    with open('data_provider/data_loader.py', 'w') as f:
        f.write(content)

with open('data_provider/m4.py', 'r') as f:
    content = f.read()
if 'import patoolib' in content and 'try:' not in content:
    content = content.replace(
        'import patoolib',
        'try:\n    import patoolib\nexcept:\n    patoolib = None'
    )
    with open('data_provider/m4.py', 'w') as f:
        f.write(content)

print("\nâœ… ç¯å¢ƒè®¾ç½®å®Œæˆï¼")

import torch
print(f"âœ… PyTorch: {torch.__version__}")
print(f"âœ… CUDA: {torch.cuda.is_available()}")
if torch.cuda.is_available():
    print(f"âœ… GPU: {torch.cuda.get_device_name(0)}")


# =============================================================================
# ä»£ç å— 2: å¿«é€ŸéªŒè¯ï¼ˆå¯é€‰ï¼Œ5-10åˆ†é’Ÿï¼‰
# =============================================================================
# è¿è¡Œè¿™ä¸ªå¯ä»¥éªŒè¯ç¯å¢ƒæ˜¯å¦æ­£ç¡®ï¼Œå¯é€‰
!python3 quick_verify_setup.py


# =============================================================================
# ä»£ç å— 3: ç”Ÿæˆä¼˜åŒ–æ•°æ®ï¼ˆ2åˆ†é’Ÿï¼‰
# =============================================================================
import os
os.chdir('/content/TimeSeriesForecast')

print("ğŸ”§ ç”Ÿæˆä¼˜åŒ–çš„AEMOæ•°æ®...")
!python3 generate_optimized_aemo_data.py

# éªŒè¯æ•°æ®
import pandas as pd
data_dir = './data/AEMO_optimized'
files = sorted([f for f in os.listdir(data_dir) if f.endswith('.csv')])

print(f"\nğŸ“Š ç”Ÿæˆäº† {len(files)} ä¸ªæ–‡ä»¶:")
for freq in ['30min', '15min', '5min']:
    freq_files = [f for f in files if freq in f]
    if freq_files:
        print(f"\n{freq} æ•°æ® ({len(freq_files)} ä¸ªæ–‡ä»¶):")
        for f in freq_files[:2]:
            df = pd.read_csv(f'{data_dir}/{f}')
            print(f"  - {f:25s}: {len(df):6d} è¡Œ")
        if len(freq_files) > 2:
            print(f"  ... è¿˜æœ‰ {len(freq_files)-2} ä¸ªæ–‡ä»¶")


# =============================================================================
# ä»£ç å— 4: è¿è¡Œä¸‰é˜¶æ®µè®­ç»ƒï¼ˆ6-8å°æ—¶ï¼‰â­ æ ¸å¿ƒæ­¥éª¤
# =============================================================================
import os
os.chdir('/content/TimeSeriesForecast')

print("="*80)
print("ğŸš€ å¼€å§‹ä¸‰é˜¶æ®µè®­ç»ƒ")
print("="*80)
print("é¢„è®¡æ—¶é—´åˆ†é…:")
print("  - é˜¶æ®µ1 (æ¨¡å‹ç­›é€‰): 1-2å°æ—¶")
print("  - é˜¶æ®µ2 (æ‰©å±•éªŒè¯): 3-4å°æ—¶")
print("  - é˜¶æ®µ3 (æ­¥é•¿æ‰©å±•): 2-3å°æ—¶")
print("  - æ€»è®¡: 6-8å°æ—¶")
print("="*80)
print()

# è¿è¡Œä¸‰é˜¶æ®µè®­ç»ƒ
!python3 three_stage_training.py

print("\nâœ… è®­ç»ƒå®Œæˆï¼")


# =============================================================================
# ä»£ç å— 5: æŸ¥çœ‹ç»“æœ
# =============================================================================
import os
import pandas as pd
import json

os.chdir('/content/TimeSeriesForecast')

print("="*80)
print("ğŸ“Š ä¸‰é˜¶æ®µè®­ç»ƒç»“æœæ±‡æ€»")
print("="*80)

# è¯»å–æ‰€æœ‰ç»“æœ
df_all = pd.read_csv('./three_stage_results/all_results.csv')

# æŒ‰é˜¶æ®µç»Ÿè®¡
print("\nğŸ¯ å„é˜¶æ®µç»Ÿè®¡:")
for stage in [1, 2, 3]:
    df_stage = df_all[df_all['stage'] == stage]
    success_count = len(df_stage[df_stage['success'] == True])
    total_count = len(df_stage)
    avg_time = df_stage['time_minutes'].mean()
    
    stage_names = {1: "æ¨¡å‹ç­›é€‰", 2: "æ‰©å±•éªŒè¯", 3: "æ­¥é•¿æ‰©å±•"}
    print(f"\né˜¶æ®µ{stage} ({stage_names[stage]}):")
    print(f"  æˆåŠŸ: {success_count}/{total_count}")
    print(f"  å¹³å‡ç”¨æ—¶: {avg_time:.1f}åˆ†é’Ÿ")

# æœ€ä½³ç»“æœ
df_success = df_all[(df_all['success'] == True) & (df_all['mae'].notna())]

if len(df_success) > 0:
    df_success = df_success.sort_values('mae')
    
    print("\n" + "="*80)
    print("ğŸ† Top 10 æœ€ä½³ç»“æœ")
    print("="*80)
    print(df_success[['stage', 'state', 'freq', 'model', 'pred_len', 'mae', 'mse']].head(10).to_string(index=False))
    
    best = df_success.iloc[0]
    print(f"\nâœ¨ æœ€ä½³é…ç½®:")
    print(f"   æ¨¡å‹: {best['model']}")
    print(f"   å·: {best['state']}")
    print(f"   é¢‘ç‡: {best['freq']}")
    print(f"   é¢„æµ‹æ­¥é•¿: {int(best['pred_len'])}")
    print(f"   MAE: {best['mae']:.4f}")
    print(f"   MSE: {best['mse']:.4f}")
else:
    print("\nâš ï¸  æ²¡æœ‰æˆåŠŸçš„å®éªŒ")


# =============================================================================
# ä»£ç å— 6: å¯è§†åŒ–å¯¹æ¯”
# =============================================================================
import os
import pandas as pd
import matplotlib.pyplot as plt

os.chdir('/content/TimeSeriesForecast')

df_all = pd.read_csv('./three_stage_results/all_results.csv')
df_success = df_all[(df_all['success'] == True) & (df_all['mae'].notna())]

if len(df_success) > 0:
    fig, axes = plt.subplots(2, 2, figsize=(15, 12))
    
    # 1. é˜¶æ®µ1: æ¨¡å‹å¯¹æ¯”
    ax1 = axes[0, 0]
    df_stage1 = df_success[df_success['stage'] == 1]
    if len(df_stage1) > 0:
        df_stage1.groupby('model')['mae'].mean().sort_values().plot(kind='barh', ax=ax1, color='skyblue')
        ax1.set_title('é˜¶æ®µ1: æ¨¡å‹å¯¹æ¯” (å¹³å‡MAE)', fontsize=14, fontweight='bold')
        ax1.set_xlabel('MAE ($/MWh)')
        ax1.grid(True, alpha=0.3)
    
    # 2. é˜¶æ®µ2: é¢‘ç‡å¯¹æ¯”
    ax2 = axes[0, 1]
    df_stage2 = df_success[df_success['stage'] == 2]
    if len(df_stage2) > 0:
        df_stage2.groupby('freq')['mae'].mean().plot(kind='bar', ax=ax2, color='lightcoral')
        ax2.set_title('é˜¶æ®µ2: é¢‘ç‡å¯¹æ¯” (å¹³å‡MAE)', fontsize=14, fontweight='bold')
        ax2.set_ylabel('MAE ($/MWh)')
        ax2.set_xlabel('é¢‘ç‡')
        ax2.grid(True, alpha=0.3)
        ax2.set_xticklabels(ax2.get_xticklabels(), rotation=0)
    
    # 3. é˜¶æ®µ3: é¢„æµ‹æ­¥é•¿å¯¹æ¯”
    ax3 = axes[1, 0]
    df_stage3 = df_success[df_success['stage'] == 3]
    if len(df_stage3) > 0:
        df_stage3.groupby('pred_len')['mae'].mean().plot(kind='bar', ax=ax3, color='lightgreen')
        ax3.set_title('é˜¶æ®µ3: é¢„æµ‹æ­¥é•¿å¯¹æ¯” (å¹³å‡MAE)', fontsize=14, fontweight='bold')
        ax3.set_ylabel('MAE ($/MWh)')
        ax3.set_xlabel('é¢„æµ‹æ­¥é•¿')
        ax3.grid(True, alpha=0.3)
        ax3.set_xticklabels(ax3.get_xticklabels(), rotation=0)
    
    # 4. å„å·è¡¨ç°
    ax4 = axes[1, 1]
    state_avg = df_success.groupby('state')['mae'].mean().sort_values()
    state_avg.plot(kind='barh', ax=ax4, color='mediumpurple')
    ax4.set_title('å„å·è¡¨ç°å¯¹æ¯” (å¹³å‡MAE)', fontsize=14, fontweight='bold')
    ax4.set_xlabel('MAE ($/MWh)')
    ax4.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.savefig('./three_stage_results/results_visualization.png', dpi=300, bbox_inches='tight')
    print("âœ… å›¾è¡¨å·²ä¿å­˜: ./three_stage_results/results_visualization.png")
    plt.show()
else:
    print("âš ï¸  æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ç”¨äºå¯è§†åŒ–")


# =============================================================================
# ä»£ç å— 7: ä¸‹è½½æ‰€æœ‰ç»“æœ
# =============================================================================
import os
from google.colab import files

os.chdir('/content/TimeSeriesForecast')

print("ğŸ“¦ æ‰“åŒ…æ‰€æœ‰ç»“æœ...")

!zip -r aemo_optimized_results.zip \
  ./three_stage_results/ \
  ./results/ \
  ./checkpoints/ \
  -x "*.pyc" "**/__pycache__/*" \
  2>&1 | tail -10

if os.path.exists('aemo_optimized_results.zip'):
    size_mb = os.path.getsize('aemo_optimized_results.zip') / (1024 * 1024)
    print(f"\nâœ… æ‰“åŒ…å®Œæˆ: {size_mb:.1f} MB")
    
    print("\nğŸ“¥ å¼€å§‹ä¸‹è½½...")
    files.download('aemo_optimized_results.zip')
    
    print("\nâœ… ä¸‹è½½å®Œæˆï¼")
    print("\nğŸ“¦ å‹ç¼©åŒ…å†…å®¹:")
    print("  - three_stage_results/  : ä¸‰é˜¶æ®µæ±‡æ€»ç»“æœï¼ˆCSV+JSONï¼‰")
    print("  - results/             : æ‰€æœ‰å®éªŒçš„è¯¦ç»†ç»“æœ")
    print("  - checkpoints/         : è®­ç»ƒå¥½çš„æ¨¡å‹æƒé‡æ–‡ä»¶")
else:
    print("âŒ æ‰“åŒ…å¤±è´¥")


# =============================================================================
# ğŸ‰ å®Œæˆï¼
# =============================================================================
print("\n" + "="*80)
print("ğŸ‰ æ­å–œï¼æ‰€æœ‰æ­¥éª¤å®Œæˆ")
print("="*80)
print("\nğŸ“Š æ‚¨ç°åœ¨æ‹¥æœ‰:")
print("  âœ… 43ä¸ªä¼˜åŒ–å®éªŒçš„å®Œæ•´ç»“æœ")
print("  âœ… æœ€ä½³æ¨¡å‹å’Œé…ç½®çš„è¯†åˆ«")
print("  âœ… è¯¦ç»†çš„æ€§èƒ½å¯¹æ¯”å›¾è¡¨")
print("  âœ… å¯ä¾›è¿›ä¸€æ­¥åˆ†æçš„CSVæ•°æ®")
print("\nğŸ’¡ ä¸‹ä¸€æ­¥:")
print("  1. æŸ¥çœ‹ all_results.csv äº†è§£è¯¦ç»†æŒ‡æ ‡")
print("  2. æ ¹æ®æœ€ä½³é…ç½®è¿›è¡Œç”Ÿäº§éƒ¨ç½²")
print("  3. ä½¿ç”¨checkpointæ–‡ä»¶è¿›è¡Œé¢„æµ‹")
print("="*80)

